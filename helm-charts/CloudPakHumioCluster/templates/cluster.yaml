apiVersion: core.humio.com/v1alpha1
kind: HumioCluster
metadata:
  name: {{ include "CloudPakHumioCluster.fullname" . }}
  labels: {{ include "CloudPakHumioCluster.labels" . | nindent 4 }}
spec: {{ .Values.humioClusterSpec | toYaml | nindent 2 }}
  viewGroupPermissions: |-
    {
    "defaults": {
        {{ .Values.adminGroup | quote }}: {
            "queryPrefix": "*",
            "canEditMembers": true,
            "canEditAlerts": true,
            "canEditDashboards": true,
            "canEditFiles": true,
            "canEditParsers": true,
            "canEditQueries": true,
            "canEditIngestListeners": true,
            "canDeleteEvents": true,
            "canEditRetention": true,
            "canDeleteDataSources": true,
            "canDeleteDataSpace": true,
            "canChangeDeleteEventsPermission": true,
            "canEditSearchSettings": true,
            "canEditS3Archiving": true,
            "canConnectView": true,
            "canReadEvents": true,
            "canWriteEvents": true
            }
        }
    }
  environmentVariables:
    {{ if .Values.humioClusterSpec.environmentVariables }}
    {{ .Values.humioClusterSpec.environmentVariables | toYaml | nindent 4 }}
    {{ end }}
    - name: "AUTHENTICATION_METHOD"
      value: "oauth"
    - name: "AUTO_CREATE_USER_ON_SUCCESSFUL_LOGIN"
      value: "true"
    - name: "AUTO_UPDATE_GROUP_MEMBERSHIPS_ON_SUCCESSFUL_LOGIN"
      value: "true"
    - name: "OIDC_USERNAME_CLAIM"
      value: {{ .Values.OidcUsernameClaim }}
    - name: "OIDC_GROUPS_CLAIM"
      value: {{ .Values.OidcGroupsClaim }}
    - name: "OIDC_PROVIDER"
      valueFrom:
        secretKeyRef:
          name: {{ include "CloudPakHumioCluster.fullname" . }}-oidc
          key: OIDC_ISSUER_URL
    - name: "OIDC_OAUTH_CLIENT_ID"
      valueFrom:
        secretKeyRef:
          name: {{ include "CloudPakHumioCluster.fullname" . }}-oidc
          key: CLIENT_ID
    - name: "OIDC_OAUTH_CLIENT_SECRET"
      valueFrom:
        secretKeyRef:
          name: {{ include "CloudPakHumioCluster.fullname" . }}-oidc
          key: {{ include "clientSecret" . }}
    {{ if .Values.strimzi.createKafkaCluster }}
    - name: "ZOOKEEPER_URL"
      value: {{ include "CloudPakHumioCluster.fullname" . }}-zookeeper-client:2181
    - name: "KAFKA_SERVERS"
      value: {{ include "CloudPakHumioCluster.fullname" . }}-kafka-brokers:9092
    {{ end }}