apiVersion: core.humio.com/v1alpha1
kind: HumioCluster
metadata:
  name: {{ include "CloudPakHumioCluster.fullname" . }}
  labels: {{ include "CloudPakHumioCluster.labels" . | nindent 4 }}
spec: {{ .Values.humioClusterSpec | toYaml | nindent 2 }}
  {{ if .Values.strimzi.createKafkaCluster }}
  environmentVariables:
    - name: "ZOOKEEPER_URL"
      value: "humio-kafka-zookeeper-client:2181"
    - name: "KAFKA_SERVERS"
      value: "humio-kafka-kafka-brokers:9092"
  {{ end }}
  environmentVariables:
    - name: "AUTHENTICATION_METHOD"
      value: "oauth"
    - name: "AUTO_CREATE_USER_ON_SUCCESSFUL_LOGIN"
      value: "true"
    - name: "OIDC_USERNAME_CLAIM"
      value: "email" {{ /* TODO use uid instead if possible */ }}
    - name: "OIDC_PROVIDER"
      valueFrom:
        secretKeyRef:
          name: {{ include "CloudPakHumioCluster.fullname" . }}-oidc
          key: OIDC_ISSUER_URL
    - name: "OIDC_OAUTH_CLIENT_ID"
      valueFrom:
        secretKeyRef:
          name: {{ include "CloudPakHumioCluster.fullname" . }}-oidc
          key: CLIENT_ID
    - name: "OIDC_OAUTH_CLIENT_SECRET"
      valueFrom:
        secretKeyRef:
          name: {{ include "CloudPakHumioCluster.fullname" . }}-oidc
          key: CLIENT_SECRET